# Dataflow í™•ë¥ ì  Hot Key ë¡œê±°

ì´ í”„ë¡œì íŠ¸ëŠ” Google Cloud Dataflow(Apache Beam)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„°ì—ì„œ **Hot Key**(ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ ë¹ˆë„ë¥¼ ê°€ì§„ í‚¤)ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê°ì§€í•˜ê³  ë¡œê¹…í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

## ğŸš€ ì£¼ìš” íŠ¹ì§•

### 1. í™•ë¥ ì  ìŠ¤ì¼€ì¹­ (Count-Min Sketch)
ëŒ€ëŸ‰ì˜ íŠ¸ë˜í”½ í™˜ê²½ì—ì„œ ìˆ˜ë°±ë§Œ ê°œì˜ ê³ ìœ  í‚¤ì— ëŒ€í•œ ë¹ˆë„ë¥¼ ì§‘ê³„í•˜ëŠ” ê²ƒì€ ë©”ëª¨ë¦¬ ë¶€ì¡±(OOM) ì˜¤ë¥˜ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ëŠ” **Count-Min Sketch** ì•Œê³ ë¦¬ì¦˜ì„ í™œìš©í•˜ì—¬ ë‹¤ìŒì„ ì œê³µí•©ë‹ˆë‹¤:
- **ê³ ì •ëœ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ë°ì´í„°ì˜ ì–‘ì´ë‚˜ ê³ ìœ  í‚¤ì˜ ìˆ˜ì— ìƒê´€ì—†ì´ ì¼ì •í•œ ë©”ëª¨ë¦¬ë¥¼ ì ìœ í•©ë‹ˆë‹¤.
- **í™•ë¥ ì  ì¶”ì •**: ì ˆëŒ€ì ì¸ ì •í™•ë„ ëŒ€ì‹  ê·¹ë‹¨ì ì¸ íš¨ìœ¨ì„±ì„ ì·¨í•˜ì—¬ ê±°ì˜ ì‹¤ì‹œê°„ì— ê°€ê¹Œìš´ ë¹ˆë„ ì¶”ì •ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
- **10% ìƒ˜í”Œë§ ë° ì™¸ì‚½(Extrapolation)**: ì´ˆê³ ë¶€í•˜ íŠ¸ë˜í”½ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ëª¨ë“  ìš”ì†Œì— ëŒ€í•´ ìŠ¤ì¼€ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì€ ë¹„ìš©ì´ ë§ì´ ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì œ ìŠ¤ì¼€ì¹˜ë¥¼ ìœ„í•´ ìš”ì†Œì˜ 10%ë§Œ ìƒ˜í”Œë§í•˜ê³  ê²°ê³¼ë¥¼ 10ë°°ë¡œ ë³´ì •(x10)í•˜ì—¬ Hot Keyë¥¼ ê°ì§€í•¨ìœ¼ë¡œì¨ ìŠ¤ì¼€ì¹˜ ì—…ë°ì´íŠ¸ ì˜¤ë²„í—¤ë“œë¥¼ 90% ì¤„ì˜€ìŠµë‹ˆë‹¤.
- **Combiner Lifting (ìµœì í™”)**: `globally()` ì§‘ê³„ë¥¼ í™œìš©í•˜ì—¬ Map-side ê²°í•©ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê° ì›Œì»¤ê°€ ë¡œì»¬ ë¶€ë¶„ ì§‘ê³„ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì…”í”Œì„ íšê¸°ì ìœ¼ë¡œ ì¤„ì´ê³  ë°ì´í„° ì „ì†¡ ë‹¨ê³„ì—ì„œì˜ Hot Key ë³‘ëª© í˜„ìƒì„ ë°©ì§€í•©ë‹ˆë‹¤.

### 2. ì‚¬ì´ë“œì¹´ íŒ¨í„´
ê°ì§€ ë¡œì§ì€ ë©”ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ íŒŒì´í”„ë¼ì¸ê³¼ **ë³„ë„ì˜ ë¸Œëœì¹˜**ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
- **ì•ˆì •ì„±**: ê°ì§€ ë¡œì§ì˜ ë¶€í•˜ë‚˜ ì§€ì—°ì´ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë°ì´í„° ì²˜ë¦¬ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
- **ìœ ì—°ì„±**: ë©”ì¸ ë¡œì§ì„ ë³€ê²½í•˜ì§€ ì•Šê³ ë„ ê°ì§€ ì•Œê³ ë¦¬ì¦˜ì´ë‚˜ ì„ê³„ê°’ì„ ë…ë¦½ì ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3. ìµœì í™”ëœ ë¡œê¹… ë° í™•ì¥ì„±
- **ë¡œê·¸ ìƒ˜í”Œë§**: ë©”ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¸Œëœì¹˜ëŠ” ê°€ì‹œì„±ì„ ìœ ì§€í•˜ë©´ì„œ ë¡œê·¸ í­ì¦ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ **1,000ê°œ ë ˆì½”ë“œ**ë§ˆë‹¤ í•œ ë²ˆì”©ë§Œ ì²˜ë¦¬ ìƒíƒœë¥¼ ìƒ˜í”Œë§í•˜ì—¬ ë¡œê¹…í•©ë‹ˆë‹¤.
- **Beam ë©”íŠ¸ë¦­ í†µí•©**: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ ê¸°ë³¸ ì œê³µ ë©”íŠ¸ë¦­:
    - `detected_hot_keys` (Counter): ì‹ë³„ëœ Hot Keyì˜ ì´ ê°œìˆ˜ë¥¼ ì¶”ì í•©ë‹ˆë‹¤.
    - `estimated_counts_dist` (Distribution): ìœˆë„ìš° ì „ë°˜ì— ê±¸ì¹œ ì¶”ì • ë¹ˆë„ì˜ ë¶„í¬ë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.
- **Dataflow Streaming Engine**: ìƒíƒœ ê´€ë¦¬ë¥¼ ì˜¤í”„ë¡œë“œí•˜ê³  Google Cloudì—ì„œì˜ ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´ ëª…ì‹œì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ— ì•„í‚¤í…ì²˜ ê°œìš”

```mermaid
graph TD
    A[ë°ì´í„° ì†ŒìŠ¤] --> B[ê³ ì • ìœˆë„ìš°]
    B --> C[ë©”ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¸Œëœì¹˜]
    B --> D[ì‚¬ì´ë“œì¹´ ëª¨ë‹ˆí„° ë¸Œëœì¹˜]
    D --> E[Count-Min Sketch ìƒì„±]
    E --> F[Side Input]
    C --> G[í™•ë¥ ì  ë¹ˆë„ ì¶”ì •]
    F --> G
    G --> H{ì„ê³„ê°’ ì´ˆê³¼?}
    H -- ì˜ˆ --> I[ë¡œê·¸ ê²½ê³ /ë©”íŠ¸ë¦­ ê¸°ë¡]
    H -- ì•„ë‹ˆì˜¤ --> J[ë¬´ì‹œ]
```

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ
- **ì–¸ì–´**: Java 25
- **í”„ë ˆì„ì›Œí¬**: Apache Beam 2.70.0
- **ë°ì´í„° êµ¬ì¡°**: Count-Min Sketch (`beam-sdks-java-extensions-sketching`)
- **ëŸ¬ë„ˆ**: DirectRunner (ë¡œì»¬ í…ŒìŠ¤íŠ¸) / DataflowRunner (ìš´ì˜)

## ğŸƒ ì‹¤í–‰ ë°©ë²•

### ì‚¬ì „ ìš”êµ¬ ì‚¬í•­
- JDK 25 ì´ìƒ
- Apache Maven 3.9 ì´ìƒ
- Google Cloud SDK (Dataflow ì‹¤í–‰ ì‹œ í•„ìš”)

### ë¡œì»¬ ì‹¤í–‰ (DirectRunner)
ë°ì´í„° ë¶„í¬ê°€ ì™œê³¡ëœ ê°€ìƒ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì—¬ Hot Key ê°ì§€ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

```bash
mvn compile exec:java \
  -Dexec.mainClass=com.example.dataflow.HotKeyLoggerPipeline \
  -Dexec.args="--runner=DirectRunner \
               --windowDurationSeconds=10 \
               --hotKeyThreshold=500"
```

### ì£¼ìš” íŒŒë¼ë¯¸í„°
- `--windowDurationSeconds`: ë¹ˆë„ë¥¼ ì§‘ê³„í•  ìœˆë„ìš° í¬ê¸°(ì´ˆ ë‹¨ìœ„).
- `--hotKeyThreshold`: Hot Keyë¡œ íŒë‹¨í•  ìµœì†Œ ì¹´ìš´íŠ¸.
- `--epsilon`: ìŠ¤ì¼€ì¹­ ì•Œê³ ë¦¬ì¦˜ì˜ ìƒëŒ€ì  ì˜¤ì°¨ (ê¸°ë³¸ê°’: 0.01).
- `--confidence`: ìŠ¤ì¼€ì¹­ ì•Œê³ ë¦¬ì¦˜ì˜ ì‹ ë¢° ìˆ˜ì¤€ (ê¸°ë³¸ê°’: 0.99).

## ğŸ“ ì½”ë“œ êµ¬ì¡°
- `HotKeyLoggerPipeline.java`: íŒŒì´í”„ë¼ì¸ êµ¬ì„± ë° ì‹¤í–‰ ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸.
- `SketchBasedHotKeyDetector.java`: í™•ë¥ ì  Count-Min Sketch ê¸°ë°˜ ê°ì§€ë¥¼ ìœ„í•œ ì‚¬ì´ë“œì¹´ íŠ¸ëœìŠ¤í¼.
- `SyntheticDataGenerator.java`: í‚¤ ë¶„í¬ê°€ ì™œê³¡ëœ(ì˜ˆ: Zipfian í˜•íƒœ) ê°€ìƒ ë°ì´í„° ìƒì„±ê¸°.

## ğŸ” ëª¨ë‹ˆí„°ë§
íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œ ì ì¬ì ì¸ Hot Keyë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê²½ê³  ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”:
`[Sketch-Sampling-Sidecar] Detected Potential HOT KEY: [hot-key-A], Extrapolated Count: [1465] (Sampled: 146)`

ë˜í•œ ë©”ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìƒ˜í”Œë§ì„ ëª¨ë‹ˆí„°ë§í•˜ì‹­ì‹œì˜¤:
`[Main-Business-Sample] Processed 1000 keys. Current Sample - Key: hot-key-A, Count: 482`

ì´ í”„ë¡œì íŠ¸ëŠ” ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œì—ì„œ ì‰½ê²Œ ì‹œê°í™”í•  ìˆ˜ ìˆë„ë¡ Apache Beam Metricsì™€ í†µí•©ë˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
